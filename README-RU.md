# **Тестовое задания для ООО "БАЗАЛЬТ СПО"**
## Описание

>У нас есть публичный REST API для нашей базы данных:  
https://rdb.altlinux.org/api/  
У него есть метод  
/export/branch_binary_packages/{branch}  
в качестве бранча можно использовать sisyphus и p10  
Нужно сделать модуль python и cli утилиту linux (использующую этот модуль на python), которая:  
>1) получает списки бинарных пакетов ветки sisyphus и p10  
>2) делает сравнение полученных списков пакетов и выводит JSON (структуру нужно придумать), в котором будет отображено:  
>- все пакеты, которые есть в p10 но нет в sisyphus  
>- все пакеты, которые есть в sisyphus но их нет в p10  
>- все пакеты, version-release которых больше в sisyphus чем в   
>Это нужно сделать для каждой из поддерживаемых веткой архитектур (поле arch в ответе).  
>Процесс разработки нужно оформить в виде git репозитория с историей всех изменений  
>с самого первого этапа (без переписывания коммитов) и выложить, например, на github  
>Утилита должна запускаться под операционной системой Linux (проверяться будет на ALT Linux, версии 10),  
>к ней должно быть README на английском языке, содержащее инструкцию по запуску.  
>Сравнение version-release согласно правилам версионирования rpm пакетов.
>
>Cайт работающий на базе этого API - https://packages.altlinux.org/ru/sisyphus/.


## Язык программирования
- Python
## Библиотеки и инструменты
- setuptools — библиотека для сборки приложения в Python-пакет.
- argparse — для парсинга аргументов командной строки в Python.
- asyncio — для асинхронного получения JSON данных от внешнего API.
- aiohttp — для создания асинхронного HTTP-клиента
- multiprocessing — для создания параллельных процессов и выполнения задач в нескольких ядрах процессора в Python.  
В моём случае применяется если большой объём данных нужно отсортировать. И если позволяет железо.
- json — для работы с данными в формате JSON: их сериализации и десериализации.
- os — нужна для получения имени пользователя, которое попадает в финальный JSON ответ.
- re — применил для удобного разделения версий пакетов.
- sys — для вывода ответа в stdout.
- dataclasses — создание класса, с которым происходит основная логика приложения.
- pathlib — для работы с путями в системе.
- typing —  для добавления аннотаций типов и статической проверки типов.

## Принцип работы
### ***Парсинг данных***
Парсинг данных происходит асинхронно, так-как это I/O-Bound был выбран данный способ.  
Так как у нас есть конкретный URL на который нужно отправлять запрос, приложение не предполагает его замену.  
Запрос идёт по адресу: https://rdb.altlinux.org/api/export/branch_binary_packages/{branch}, где {branch} название ветки.  
После проверки удачного получения данных, достаются нужные пакеты по ключу "packages" и передаются для дальнейшей работы с ними.  
В случае ошибки, в консоль отправляется ошибка с названием ветки в которой она произошла и статус код ошибки.  

### ***Обработка данных***
Обработчик получает два списка пакетов, определяет их кол-во. Если общее кол-во пакетов более 1.600.000, то приложение  
будет проверять параметры железа, для попытки запуска расчётов в многопоточном режиме.  
Как происходит проверка:
- В обработчик поступает два списка пакетов, он определяет их кол-во.
  - Если общее кол-во пакетов менее чем 1.600.000 то сортировка будет производиться в обычном синхронном режиме.  
  - Если больше, то происходит получение информации о кол-ве ядер процессора, на котором работает приложение.
  - Если в системе 3 и более ядер, то сортировка будет происходить в трёх процессах, что значительно повышает время выполнения сортировки.
  - Если в системе 2 ядра, то и дёт проверка, что общее кол-во пакетов более чем 2.100.000, если их меньше, то быстрее работает  
    синхронный способ сортировки, если их больше, то будет выполняться сортировка в двух процессах.
  - Иначе выполнение будет происходить в обычном синхронном режиме.
- После выбора режима сортировки происходит передача данных в основную логику.
- Вызывается функция для работы с данными.
  - В ней происходит создание tuple (для быстрого доступа по хешу, пакета с которым будет идти сравнение), на основе  
    ключей по которым будет происходить сортировка.
  - Пакеты которые будут сравниваться, проходят обработку для для получения нужных ключей и сравнивание их с 2 пакетом.
  - Получившейся список пакетов отдаётся на дальнейшую обработку (в итоге получается два списка пакетов с уникальными данными).
- Происходит поиск в первом списке пакетов более новых version-release.
  - Происходит обработка пакетов, создание словаря с ключём ввиде tuple(name, arch), и значениеми (epoch, version, release)  
    после чего словарь отдаётся для дальнейшей обработки.
  - Далее происходит сортировка.
    - Берётся список пакетов в котором нужно найти более новые версии.
    - В цикле проходим по списку, формируем tuple(name, arch) и ищем его в словаре который получили ранее.
    - Далее сравнение идёт по такому сценарию
      - Сравниваем epoch
      - Сравниваем version
      - Сравниваем release
      - Более новые из первого списка добавляем в список
      - отдаём готовый список
- Готовые результаты передаются для формировки ответа
  - Происходит создание JSON
  - В зависимости от выбранных опций ответ записывается в файл, консоль


### ***Установка***

1. Скопируйте репозиторий:
```bash
   git clone https://github.com/likeThatDude/test-job-bazalt-spo.git
```
```bash
   git clone git@github.com:likeThatDude/test-job-bazalt-spo.git
```
2. Находясь в папке с [setup.py](setup.py)
```bash
   pip install .
```
3. Выполните команду
```bash
   compare_packages --branch1 p10 --branch2 sisyphus
```
- Дополнительные свойства 
  - --branch1 первая ветка.
  - --branch2 вторая ветка, в которой будут искаться более новые версии пакетов.
  - --write папка куда будет сохранён файл .json, если флаг не применить файл записан не будет.
  - --console для вывода результата в консоль, если не применить флаг, вывода в консоль не будет.

# Разработчик
**Gorbatenko Ivan**

**GitHub**: https://github.com/likeThatDude  

**Email**: 1995van95@gmail.com